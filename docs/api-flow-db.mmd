sequenceDiagram
    autonumber
    participant Client as ğŸŒ Client/Frontend
    participant Express as âš¡ Express Server
    participant CORS as ğŸ”“ CORS Middleware
    participant Route as ğŸ›£ï¸ Route Handler
    participant Validator as âœ… express-validator
    participant Auth as ğŸ” Auth Middleware
    participant Controller as ğŸ® Controller
    participant Model as ğŸ—„ï¸ Mongoose Model
    participant MongoDB as ğŸƒ MongoDB Atlas
    participant External as ğŸŒ External Services
    
    rect rgb(200, 230, 255)
    Note over Client,MongoDB: ğŸš€ API REQUEST FLOW WITH DATABASE CONNECTION
    end
    
    rect rgb(230, 245, 255)
    Note over Client,Express: â•â•â• STEP 1: REQUEST ENTRY â•â•â•
    Client->>+Express: ğŸ“¨ HTTP Request (POST/GET/PUT/DELETE)
    Express->>+CORS: ğŸ” Apply CORS Policy
    CORS-->>-Express: âœ… CORS Allowed
    
    Express->>+Route: ğŸ¯ Match Route Pattern<br/>ğŸ“ /api/auth/login<br/>ğŸ“ /api/patients/:id<br/>ğŸ“ /api/appointments
    end
    
    rect rgb(255, 240, 240)
    Note over Route,MongoDB: â•â•â• STEP 2: AUTHENTICATION & AUTHORIZATION â•â•â•
    alt ğŸ” Protected Route
        Route->>+Auth: ğŸ”‘ verifyToken()
        Auth->>Auth: ğŸ“¤ Extract JWT from Header
        Auth->>Auth: ğŸ” jwt.verify(token, JWT_SECRET)
        
        alt âœ… Token Valid
            Auth->>+MongoDB: ğŸ” User.findById(decoded.id)
            MongoDB-->>-Auth: ğŸ“„ User Document
            Auth->>Auth: âœ“ Check user.isActive
            
            alt ğŸ‘¤ User is Professional/Patient
                Auth->>+MongoDB: ğŸ”— Populate profileId
                MongoDB-->>-Auth: ğŸ“‹ Full Profile Data
            end
            
            Auth-->>-Route: âœ… req.user = {id, role, profileId, profile}
        else âŒ Token Invalid/Expired
            Auth-->>Client: ğŸš« 401 Unauthorized
        end
        
        opt ğŸ­ Role-Based Access Control
            Route->>+Auth: ğŸ‘® requireRole(['admin', 'professional'])
            Auth->>Auth: ğŸ” Check req.user.role
            alt âŒ Insufficient Permissions
                Auth-->>-Client: ğŸš« 403 Forbidden
            end
        end
        
        opt ğŸ”’ Profile Ownership Check
            Route->>+Auth: ğŸ†” requireOwnProfile/requireOwnPatientOrAdmin
            Auth->>Auth: ğŸ” Compare profileId with params.id
            alt âŒ Not Owner & Not Admin
                Auth-->>-Client: ğŸš« 403 Forbidden
            end
        end
    end
    end
    
    rect rgb(255, 250, 230)
    Note over Route,Validator: â•â•â• STEP 3: INPUT VALIDATION â•â•â•
    Route->>+Validator: âœ… Run Validation Rules
    Validator->>Validator: ğŸ“§ body('email').isEmail()<br/>ğŸ”’ body('password').isLength({min: 8})<br/>ğŸ§¹ sanitizeBody()
    
    alt âŒ Validation Fails
        Validator-->>Client: ğŸš« 400 Bad Request<br/>ğŸ“‹ {errors: [...]}
    else âœ… Validation Passes
        Validator->>+Controller: âœ“ Execute Controller Function
    end
    Validator->>-Validator: Complete
    end
    
    rect rgb(240, 255, 240)
    Note over Controller,MongoDB: â•â•â• STEP 4: BUSINESS LOGIC & DATA OPERATIONS â•â•â•
    Controller->>+Controller: ğŸ¯ Business Logic Processing
    
    alt ğŸ—„ï¸ Database Operation Required
        Controller->>+Model: ğŸ” Mongoose Query<br/>ğŸ“Œ User.findOne({email})<br/>ğŸ“Œ Patient.create(data)<br/>ğŸ“Œ Appointment.find({...})
        Model->>Model: âœ… Apply Schema Validation<br/>ğŸ”„ Pre/Post Hooks<br/>ğŸ”— Virtual Fields
        Model->>+MongoDB: âš¡ Execute Query
        
        alt âœ… Query Successful
            MongoDB-->>-Model: ğŸ“„ Document(s)
            Model-->>-Controller: âœ“ Processed Data
        else âŒ Query Error
            MongoDB-->>Model: âš ï¸ Error
            Model-->>Controller: ğŸš¨ Database Error
            Controller-->>-Client: ğŸš« 500 Internal Server Error
        end
    end
    end
    
    rect rgb(245, 240, 255)
    Note over Controller,External: â•â•â• STEP 5: EXTERNAL SERVICES â•â•â•
    alt ğŸŒ External Service Call
        Controller->>+External: â˜ï¸ Cloudinary Upload<br/>ğŸ“§ Resend Email<br/>ğŸ“† ICS Calendar Generation
        External-->>-Controller: âœ… Service Response
    end
    end
    
    rect rgb(240, 255, 250)
    Note over Controller,Client: â•â•â• STEP 6: RESPONSE FORMATTING â•â•â•
    Controller->>Controller: ğŸ“¦ Format Response<br/>âœ… success(res, MESSAGE_CODES, data)<br/>âŒ error(res, MESSAGE_CODES, status)
    Controller-->>-Client: ğŸ“¨ JSON Response<br/>âœ“ {success, message, data}
    end
    
    rect rgb(230, 255, 230)
    Note over Client,MongoDB: ğŸ”Œ DATABASE CONNECTION DETAILS
    Note over Express,MongoDB: ğŸƒ Mongoose connects at app startup<br/>ğŸ“¡ mongoose.connect(MONGODB_URI)<br/>ğŸ”„ Connection pooling enabled<br/>âš™ï¸ useNewUrlParser: true<br/>âš™ï¸ useUnifiedTopology: true
    end
    
    rect rgb(255, 245, 230)
    Note over Model,MongoDB: ğŸ“‹ MONGOOSE SCHEMA FEATURES<br/>âœ“ Validation Rules<br/>âœ“ Default Values<br/>âœ“ Indexes<br/>âœ“ Virtual Fields<br/>âœ“ Pre/Post Hooks<br/>âœ“ Population (References)
    end
